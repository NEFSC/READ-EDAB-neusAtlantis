#' Figure 4 : biomass vs abundance sensitivity
#' Figure 5 : biomass sensitivity vs exploitation rate scatter plot
#' Figure 5b : abundance sensitivity vs exploitation rate scatter plot

library(dplyr)
library(ggplot2)
library(ggrepel)

data.dir.fscale = '/net/work3/EDAB/atlantis/Shared_Data/fishing_sensitivity_manuscript/data/fscale_combined/'
figure.dir = '/net/work3/EDAB/atlantis/Shared_Data/fishing_sensitivity_manuscript/figures/manuscript/'

guild2spp = read.csv(here::here('diagnostics','functional_groups_match.csv'),as.is = T) %>% select(Code, Guild)
guild.colors = RColorBrewer::brewer.pal(11,'Paired')
names(guild.colors) = sort(unique(guild2spp$Guild))

data.slope = readRDS(paste0(data.dir.fscale,'robustness_fscale_combined.rds'))
data.fit = readRDS(paste0(data.dir.fscale,'biomass_numbers_fit.rds'))

data.all = data.slope %>%
  left_join(data.fit)%>%
  filter(!is.na(biomass.c))
  # mutate(biomass.steepness = ifelse(!is.na(biomass.c),biomass.c,biomass.a),
  #        number.steepness = ifelse(!is.na(number.c),number.c,number.a))

slope.1 = lm(biomass.b ~ number.b, data = data.all)
summary(slope.1)

data.all.noSSH = data.all %>% filter(Code != 'SSH')
slope.1b = lm(biomass.b~number.b, data = data.all.noSSH)
summary(slope.1b)

ggplot(data = data.all, aes(x = number.b,y = biomass.b, color = Guild,label = Code))+
  scale_color_manual(values = guild.colors)+
  geom_text_repel(alpha =0.8,size = 5,max.overlaps = 100)+
  geom_abline(slope = 1, lty =2)+
  # scale_x_continuous(breaks = 0:4,limits =c(0,4))+
  # scale_y_continuous(breaks = 0:4,limits = c(0,4))+
  # geom_text_repel()+
  xlab('Abundance Sensitivity')+
  ylab('Biomass Sensitivity')+
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave(paste0(figure.dir,'/Figure_4_Constant_Catch_Sensitivity.png'),width = 8,height = 6,units = 'in',dpi = 300)

ggplot(data = data.all, aes(x = number.b,y = biomass.b,label = Code))+
  stat_smooth(method = 'lm',color = 'grey50')+
  scale_color_manual(values = guild.colors)+
  geom_point(alpha = 0.8,size =5 ,aes(color = Guild))+
  # geom_text_repel(alpha =0.8,size = 5,max.overlaps = 100)+
  geom_abline(slope = 1, lty =2)+
  # scale_x_continuous(breaks = 0:4,limits =c(0,4))+
  # scale_y_continuous(breaks = 0:4,limits = c(0,4))+
  # geom_text_repel()+
  xlab('Abundance Sensitivity')+
  ylab('Biomass Sensitivity')+
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave(paste0(figure.dir,'/Figure_4b_Constant_Catch_Sensitivity.png'),width = 8,height = 6,units = 'in',dpi = 300)


bio.lm =lm(biomass.b~exploit.prop,data.all)
summary(bio.lm)

ggplot(data = data.all, aes(x = exploit.prop,y = biomass.b))+
  stat_smooth(method = 'lm',color = 'grey50')+
  # geom_text_repel(alpha =0.8,size = 5,max.overlaps = 30,aes(color = Guild,label = Code))+
  geom_point(aes(color = Guild),size = 4,alpha = 0.5)+
  scale_color_manual(values = guild.colors)+
  xlab('Contemporary Exploitation')+
  ylab('Biomass Sensitivity')+
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave(paste0(figure.dir,'/Figure_5_Biomass_Sensitivity_Exploitation.png'),width = 8,height = 6,units = 'in',dpi = 300)


num.lm =lm(number.b~exploit.prop,data.all)
summary(num.lm)

ggplot(data = data.all, aes(x = exploit.prop,y = number.b))+
  stat_smooth(method = 'lm',color = 'grey50')+
  # geom_text_repel(alpha =0.8,size = 5,max.overlaps = 30,aes(color = Guild,label = Code))+
  geom_point(aes(color = Guild),size = 4,alpha = 0.5)+
  scale_color_manual(values = guild.colors)+
  xlab('Contemporary Exploitation')+
  ylab('Abundance Sensitivity')+
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave(paste0(figure.dir,'/Figure_5b_Abundance_Sensitivity_Exploitation.png'),width = 8,height = 6,units = 'in',dpi = 300)


# ggplot(data = data.all, aes(x = log10(number.b),y = log10(biomass.b), color = Guild,label = Code))+
#   scale_color_manual(values = guild.colors)+
#   geom_text_repel(alpha =0.8,size = 5,max.overlaps = 50)+
#   geom_abline(slope = 1, lty =2)+
#   # scale_x_continuous(breaks = 0:4,limits =c(0,4))+
#   # scale_y_continuous(breaks = 0:4,limits = c(0,4))+
#   # geom_text_repel()+
#   xlab('Abundance Sensitivity')+
#   ylab('Biomass Sensitivity')+
#   theme_bw()+
#   theme(legend.position = 'bottom')
