#' Figure 6: Scatterplots of thresholds vs contemporary exploitation rate from baseline
#' Figure 6a: Sustained threshold
#' Figure 6b: Recovery threshold

#Define source data and figures directories
data.dir.fscale = '/net/work3/EDAB/atlantis/Shared_Data/fishing_sensitivity_manuscript/data/fscale_combined/'
data.dir.fspike = '/net/work3/EDAB/atlantis/Shared_Data/fishing_sensitivity_manuscript/data/fspike_combined/'

figure.dir = '/net/work3/EDAB/atlantis/Shared_Data/fishing_sensitivity_manuscript/figures/manuscript/'

ref.run.dir = '/net/work3/EDAB/atlantis/Shared_Data/fishing_sensitivity_manuscript/reference_run/fishing_sensitivity_baseline/'

#Read in functional groups
fgs = read.csv(here::here('currentVersion','neus_groups.csv'),as.is = T) %>%
  filter(IsTurnedOn == T)%>%
  select(Code, LongName)
guild2spp = read.csv(here::here('diagnostics','functional_groups_match.csv')) %>%
  select(Code,LongName,Guild)

#Define Plot Colors
guild.colors = RColorBrewer::brewer.pal(11,'Paired')
names(guild.colors) = sort(unique(guild2spp$Guild))

#Read in baseline scenario data 
ref.data = readRDS(paste0(ref.run.dir,'Post_Processed/Data/ref_run_summary.rds'))%>%
  rename(biomass.age.mean.ref = 'biomass.age.mean')

#Readh in scenario setup files
setup.fscale = read.csv(here::here('diagnostics','scenario_db','fscale_combined_setup.csv'),as.is = T) %>%
  select(run.id,scalar,target.species)
setup.fspike = read.csv(here::here('diagnostics','scenario_db','fspike_combined_setup.csv'),as.is = T) %>%
  select(run.id,scalar,target.species)

guild2spp = read.csv(here::here('diagnostics','functional_groups_match.csv')) %>%
  select(Code,LongName,Guild)

data.thresh.fspike = readRDS(paste0(data.dir.fspike,'recovery_threshold_fspike_combined.rds'))%>%
  left_join(guild2spp)%>%
  arrange(Guild)%>%
  left_join(ref.data)%>%
  rename(max.scalar = 'max.recovery')%>%
  mutate(experiment.id = 'Disturbance-Recovery')

data.thresh.fscale = readRDS(paste0(data.dir.fscale,'threshold_scalar_fscale_combined.rds'))%>%
  mutate(experiment.id = 'Sustained Fishing')

data.thresh.all = bind_rows(data.thresh.fspike,data.thresh.fscale)
  

order.df = data.thresh.all %>%
  group_by(experiment.id,LongName)%>%
  summarise(max.scalar.order = max(max.scalar,na.rm=T))

data.thresh.all = data.thresh.all %>%
  left_join(order.df)%>%
  filter(is.finite(max.scalar) & !is.na(Guild))%>%
  filter(Guild != 'Other')

ggplot(data = data.thresh.all,aes(x= exploit.prop,y=max.scalar,color = Guild))+
  geom_point(size =2)+
  scale_color_manual(values = guild.colors)+
  facet_wrap(~experiment.id,nrow = 2)+
  guides(color= guide_legend(title.position = 'left',nrow = 1,title = ''))+
  ylab('Max Scalar')+
  xlab('Contemporary Exploitation Rate')+
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave(paste0(figure.dir,'Figure_6_thresholds_v_F.png'),width = 8, height = 6, units = 'in', dpi = 300)

ggplot(data = data.thresh.all,aes(x= reorder(LongName,max.scalar.order),y=max.scalar,fill = Guild))+
  geom_bar(stat = 'identity',color ='black',lwd = 0.1)+
  facet_wrap(~experiment.id,nrow = 1)+
  scale_fill_manual(values = guild.colors)+
  guides(fill= guide_legend(title.position = 'left',nrow = 1))+
  coord_flip()+
  ylab('Max Scalar')+
  xlab('')+
  theme_bw()+
  theme(legend.position = 'bottom')
ggsave(paste0(figure.dir,'Figure_6_ALT_thresholds_v_F.png'),width = 10, height = 10, units = 'in', dpi = 300)

# data.thresh.all.low = data.thresh.all %>%
#   filter(max.scalar <= 10)
# 
# ggplot(data = data.thresh.all.low,aes(x= reorder(LongName,max.scalar.order),y=max.scalar,fill = Guild))+
#   geom_bar(stat = 'identity')+
#   facet_wrap(~experiment.id,nrow = 1)+
#   guides(fill= guide_legend(title.position = 'left',nrow = 1))+
#   coord_flip()+
#   ylab('Max Scalar')+
#   xlab('')+
#   theme_bw()+
#   theme(legend.position = 'bottom')
# ggsave(paste0(figure.dir,'Figure_6_ALT_thresholds_v_F_Less10.png'),width = 10, height = 10, units = 'in', dpi = 300)

