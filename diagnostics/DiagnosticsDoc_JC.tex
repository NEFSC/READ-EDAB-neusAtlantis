% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Atlantis Diagnostics Development Documentation},
  pdfauthor={Sarah Gaichas},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering

\title{Atlantis Diagnostics Development Documentation}
\author{Sarah Gaichas}
\date{17 January, 2020}

\begin{document}
\maketitle

\hypertarget{intro}{%
\subsection{Intro}\label{intro}}

Here we document the development Atlantis diagnostics code to determine
whether the model is meeting define performance and review criteria.
Code we be developed to evaluate the model output against detailed
performance criteria developed in
{[}\protect\hyperlink{ref-kaplan_guinea_2016}{1}{]} and the calibration
criteria in
{[}\protect\hyperlink{ref-pethybridge_calibrating_2019}{2}{]}:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  All functional groups persist
\item
  Model stabilizes for the last \textasciitilde20 years of an unfished,
  unperturbed 80-100 year run
\item
  Details for calibration:

  \begin{itemize}
  \tightlist
  \item
    Unfished system:

    \begin{itemize}
    \tightlist
    \item
      produce stable biomass through time under stable-environmental
      forcing
    \item
      keep all groups from going extinct
    \item
      obtain stable biomasses that are not oscillating more than a
      certain percentage from initial values
    \end{itemize}
  \item
    System with constant fishing: reproduce realistic responses to a
    range of fishing pressures
  \end{itemize}
\item
  Hindcast period established where we have survey/assessment time
  series with error bounds
\item
  Species groups totaling \textasciitilde80\% of system biomass should
  qualitatively match hindcast biomass trends. During calibration:
  reproduce historical trends in biomass when forcing the model with
  historical fishing and environmental drivers.
\item
  Patterns of temporal variability captured (emergent or forced with
  e.g.~recruitment time series)
\item
  Productivity for groups totaling \textasciitilde80\% of system biomass
  should qualitatively match FMSY or life history expectations
\item
  Natural mortality decreases with age for majority of groups
\item
  Age and length structure qualitatively matches expectations for
  majority of groups
\item
  Diet predicted qualitatively matches empirical diet comp for majority
  of groups
\end{enumerate}

An R function for each criterion is developed below, and a wrapper that
runs all functions will be developed and tested here.

We use these R libraries, with non-CRAN package installation
instructions in comments.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#devtools::install_github("noaa-edab/ecodata",build_vignettes=TRUE) }
\CommentTok{# suggested to use remotes::install_github instead}
\CommentTok{#devtools::install_github("r4atlantis/atlantisom")}
\CommentTok{# devtools::install_local('C:/Users/joseph.caracappa/Documents/GitHub/atlantisom/')}
\CommentTok{# remotes::install_github("noaa-edab/ecotrend")}

\KeywordTok{library}\NormalTok{(ecodata)}
\KeywordTok{library}\NormalTok{(ecotrend)}
\KeywordTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'tidyverse' was built under R version 3.6.2
\end{verbatim}

\begin{verbatim}
## Warning: package 'tidyr' was built under R version 3.6.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(atlantisom)}
\KeywordTok{library}\NormalTok{(here)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'here' was built under R version 3.6.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{source}\NormalTok{(}\StringTok{"shift_legend.R"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'cowplot' was built under R version 3.6.2
\end{verbatim}

Configure files to be read in here (can have different files to source)

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# set up files to be read in}
\CommentTok{# the below can go into a config file to be sourced}

\NormalTok{d.name <-}\StringTok{ }\KeywordTok{here}\NormalTok{(}\StringTok{"diagnostics"}\NormalTok{, }\StringTok{"testfiles"}\NormalTok{,}\StringTok{'50_year_no_fishing'}\NormalTok{) }\CommentTok{#folder with files below; e.g. here("atlantisoutput","currentrun")}
\NormalTok{functional.groups.file <-}\StringTok{ "NeusGroups_v15_unix_RM.csv"}
\NormalTok{biomass.pools.file <-}\StringTok{ "atneus_v15_test2008hydro_20180208.nc"}
\NormalTok{biol.prm.file <-}\StringTok{ "at_biol_neus_v15_scaled_diet_20190924_2.xml"}
\NormalTok{box.file <-}\StringTok{ "neus_tmerc_RM2.bgm"}
\NormalTok{initial.conditions.file <-}\StringTok{ "RMinit4_2019.nc"}
\NormalTok{run.prm.file <-}\StringTok{ "at_run_neus_v15_RM_scale_0503_nofishing.xml"}
\NormalTok{scenario.name <-}\StringTok{ "atneus_v15_JC_testv6490_nofishing"}
\NormalTok{bioind.file <-}\StringTok{ "atneus_v15_JC_testv6490_nofishingBiomIndx.txt"}
\CommentTok{# catch.file <- "atneus_v15_test2008hydro_20180208Catch.txt"}
\end{Highlighting}
\end{Shaded}

Get functional group names for other functions

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#Load functional groups}
\NormalTok{funct.groups <-}\StringTok{ }\KeywordTok{load_fgs}\NormalTok{(}\DataTypeTok{dir=}\NormalTok{d.name,}
                         \DataTypeTok{file_fgs =}\NormalTok{ functional.groups.file)}
\CommentTok{#Get just the names of active functional groups}
\NormalTok{funct.group.names <-}\StringTok{ }\NormalTok{funct.groups }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(IsTurnedOn }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(Name) }\OperatorTok{%>%}
\StringTok{  }\NormalTok{.}\OperatorTok{$}\NormalTok{Name}
\end{Highlighting}
\end{Shaded}

Get basic output parameters

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# should return all model areas}
\NormalTok{boxpars <-}\StringTok{ }\KeywordTok{load_box}\NormalTok{(d.name, box.file)}
\NormalTok{boxall <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{(boxpars}\OperatorTok{$}\NormalTok{nbox }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{))}

\CommentTok{# generalized timesteps all models}
\NormalTok{runpar <-}\StringTok{ }\KeywordTok{load_runprm}\NormalTok{(d.name, run.prm.file)}
\NormalTok{noutsteps <-}\StringTok{ }\NormalTok{runpar}\OperatorTok{$}\NormalTok{tstop}\OperatorTok{/}\NormalTok{runpar}\OperatorTok{$}\NormalTok{outputstep}
\NormalTok{stepperyr <-}\StringTok{ }\ControlFlowTok{if}\NormalTok{(runpar}\OperatorTok{$}\NormalTok{outputstepunit}\OperatorTok{==}\StringTok{"days"}\NormalTok{) }\DecValTok{365}\OperatorTok{/}\NormalTok{runpar}\OperatorTok{$}\NormalTok{toutinc}
\NormalTok{midptyr <-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\KeywordTok{median}\NormalTok{(}\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,stepperyr)))}

\CommentTok{# a survey that takes place once per year mid year}
\NormalTok{annualmidyear <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(midptyr, noutsteps, stepperyr)}

\NormalTok{timeall <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{noutsteps)}

\CommentTok{# learned the hard way this can be different from ecosystem outputs}
\NormalTok{fstepperyr <-}\StringTok{ }\ControlFlowTok{if}\NormalTok{(runpar}\OperatorTok{$}\NormalTok{outputstepunit}\OperatorTok{==}\StringTok{"days"}\NormalTok{) }\DecValTok{365}\OperatorTok{/}\NormalTok{runpar}\OperatorTok{$}\NormalTok{toutfinc}
\end{Highlighting}
\end{Shaded}

\hypertarget{persistence-test}{%
\subsubsection{Persistence test}\label{persistence-test}}

This should be run on an \textbf{unfished, unperturbed} run. Fishing or
perturbations may legitimately drive groups extinct.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# read the output atlantis biom.txt file}

\NormalTok{atBtxt <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\KeywordTok{file.path}\NormalTok{(d.name, }\KeywordTok{paste0}\NormalTok{(scenario.name, }\StringTok{"BiomIndx.txt"}\NormalTok{)), }\DataTypeTok{header=}\NormalTok{T)}
\NormalTok{groupslookup <-}\StringTok{ }\NormalTok{funct.groups }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(IsTurnedOn }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{)}

\NormalTok{atBtxttidy <-}\StringTok{ }\NormalTok{atBtxt }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(Time}\OperatorTok{:}\NormalTok{DIN) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{rename_}\NormalTok{(}\DataTypeTok{.dots=}\KeywordTok{with}\NormalTok{(groupslookup, }\KeywordTok{setNames}\NormalTok{(}\KeywordTok{as.list}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(Code)), Name))) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{gather}\NormalTok{(species, biomass, }\OperatorTok{-}\NormalTok{Time) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{yr =} \KeywordTok{ceiling}\NormalTok{(Time}\OperatorTok{/}\DecValTok{365}\NormalTok{))  }\CommentTok{# assumes BiomInd.txt time unit is days leaves initial time 0 on its own}

\CommentTok{# visualize; hardcoded pages for ~89 group model}

\NormalTok{plotB <-}\KeywordTok{ggplot}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{data=}\NormalTok{atBtxttidy, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{Time}\OperatorTok{/}\DecValTok{365}\NormalTok{,}\DataTypeTok{y=}\NormalTok{biomass, }\DataTypeTok{color=}\StringTok{"txt output B"}\NormalTok{),}
             \DataTypeTok{alpha =} \DecValTok{10}\OperatorTok{/}\DecValTok{10}\NormalTok{) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\NormalTok{ggthemes}\OperatorTok{::}\KeywordTok{theme_tufte}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"top"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{colour=}\NormalTok{scenario.name)}

\NormalTok{plotB }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{1}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/persist-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotB }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{2}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/persist-2.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotB }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{3}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/persist-3.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotB }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{4}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/persist-4.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotB }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{5}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/persist-5.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plotB }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{6}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/persist-6.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# need in annual units? Or fail when any output timestep below threshold?}
\CommentTok{# make safe for migratory species, assume that over the course of the year mean B > 0.}
\CommentTok{# assumes biomass never goes negative in atlantis}

\NormalTok{crash <-}\StringTok{ }\NormalTok{atBtxttidy }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(species, yr) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{meanB =} \KeywordTok{mean}\NormalTok{(biomass)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(meanB }\OperatorTok{<}\StringTok{ }\FloatTok{1e-4}\NormalTok{)}

\CommentTok{# flag any groups with any mean annual biomass below a threshold}

\KeywordTok{unique}\NormalTok{(crash}\OperatorTok{$}\NormalTok{species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Carrion" "MicroPB"
\end{verbatim}

\hypertarget{stability-test}{%
\subsubsection{Stability test}\label{stability-test}}

Model reaches steady state for last \textasciitilde20 years of an
unperturbed, unfished \textasciitilde100 year run. Things at 0 shouldn't
count, so run persistence test as well. For plotting, let's skip the
first 20 model years so we only look after spinup.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# read in long run from separate folder}
\NormalTok{longatBtxt <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\KeywordTok{file.path}\NormalTok{(}\KeywordTok{here}\NormalTok{(}\StringTok{"diagnostics"}\NormalTok{, }\StringTok{"testfiles"}\NormalTok{, }\StringTok{"100_year_no_fishing"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(scenario.name, }\StringTok{"BiomIndx.txt"}\NormalTok{)), }\DataTypeTok{header=}\NormalTok{T)}
\NormalTok{groupslookup <-}\StringTok{ }\NormalTok{funct.groups }\OperatorTok{%>%}\StringTok{ }\CommentTok{#assumes we have the same functional groups in this run as the shorter ones}
\StringTok{  }\KeywordTok{filter}\NormalTok{(IsTurnedOn }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{)}

\CommentTok{# read in run pars for the long run too}
\NormalTok{longrunpar <-}\StringTok{ }\KeywordTok{load_runprm}\NormalTok{(}\KeywordTok{here}\NormalTok{(}\StringTok{"diagnostics"}\NormalTok{, }\StringTok{"testfiles"}\NormalTok{, }\StringTok{"50_year_no_fishing"}\NormalTok{), run.prm.file) }\CommentTok{#assumes same name as above, it is}
\NormalTok{longnoutsteps <-}\StringTok{ }\NormalTok{longrunpar}\OperatorTok{$}\NormalTok{tstop}\OperatorTok{/}\NormalTok{longrunpar}\OperatorTok{$}\NormalTok{outputstep}

\NormalTok{longtimeall <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{longnoutsteps)}

\NormalTok{longatBtxttidy <-}\StringTok{ }\NormalTok{longatBtxt }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(Time}\OperatorTok{:}\NormalTok{DIN) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{rename_}\NormalTok{(}\DataTypeTok{.dots=}\KeywordTok{with}\NormalTok{(groupslookup, }\KeywordTok{setNames}\NormalTok{(}\KeywordTok{as.list}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(Code)), Name))) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{gather}\NormalTok{(species, biomass, }\OperatorTok{-}\NormalTok{Time) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{yr =} \KeywordTok{ceiling}\NormalTok{(Time}\OperatorTok{/}\DecValTok{365}\NormalTok{))  }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(Time }\OperatorTok{%in%}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{20}\OperatorTok{*}\DecValTok{365}\NormalTok{, }\KeywordTok{floor}\NormalTok{(longrunpar}\OperatorTok{$}\NormalTok{nyears)}\OperatorTok{*}\DecValTok{365}\NormalTok{, }\DataTypeTok{by=}\DecValTok{365}\NormalTok{)) }


\CommentTok{# look for non-significant slope over last 20 years? 30 years would be better}
\NormalTok{nlast <-}\StringTok{ }\DecValTok{20}

\NormalTok{startlast <-}\StringTok{ }\KeywordTok{floor}\NormalTok{(longrunpar}\OperatorTok{$}\NormalTok{nyears)}\OperatorTok{-}\NormalTok{nlast}

\CommentTok{#warning, was getting different behavior with this code on my linux machine}

\NormalTok{stable <-}\StringTok{ }\NormalTok{longatBtxttidy }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(Time }\OperatorTok{%in%}\StringTok{ }\KeywordTok{seq}\NormalTok{(startlast}\OperatorTok{*}\DecValTok{365}\NormalTok{, }\KeywordTok{floor}\NormalTok{(longrunpar}\OperatorTok{$}\NormalTok{nyears)}\OperatorTok{*}\DecValTok{365}\NormalTok{, }\DataTypeTok{by=}\DecValTok{365}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(species) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{yr, }\DataTypeTok{y=}\NormalTok{biomass)) }\OperatorTok{+}
\StringTok{  }\NormalTok{ggthemes}\OperatorTok{::}\KeywordTok{theme_tufte}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{data=}\NormalTok{longatBtxttidy, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{yr, }\DataTypeTok{y=}\NormalTok{biomass)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_gls}\NormalTok{(}\DataTypeTok{warn =} \OtherTok{FALSE}\NormalTok{)}


\NormalTok{stable }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{1}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/stability-1.pdf}

\begin{verbatim}
## Error in nlme::gls(y ~ 1, data = data, correlation = nlme::corAR1(form = ~x),  : 
##   singular convergence (7)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stable }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{2}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/stability-2.pdf}

\begin{verbatim}
## Error in nlme::gls(y ~ 1, data = data, correlation = nlme::corAR1(form = ~x),  : 
##   singular convergence (7)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stable }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{3}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/stability-3.pdf}

\begin{verbatim}
## Error in nlme::gls(y ~ 1, data = data, correlation = nlme::corAR1(form = ~x),  : 
##   singular convergence (7)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stable }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{4}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/stability-4.pdf}

\begin{verbatim}
## Error in nlme::gls(y ~ 1, data = data, correlation = nlme::corAR1(form = ~x),  : 
##   singular convergence (7)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stable }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{5}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/stability-5.pdf}

\begin{verbatim}
## Error in nlme::gls(y ~ 1, data = data, correlation = nlme::corAR1(form = ~x),  : 
##   singular convergence (7)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stable }\OperatorTok{+}\StringTok{ }\NormalTok{ggforce}\OperatorTok{::}\KeywordTok{facet_wrap_paginate}\NormalTok{(}\OperatorTok{~}\NormalTok{species, }\DataTypeTok{ncol=}\DecValTok{4}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{4}\NormalTok{, }\DataTypeTok{page =} \DecValTok{6}\NormalTok{, }\DataTypeTok{scales=}\StringTok{"free"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{DiagnosticsDoc_JC_files/figure-latex/stability-6.pdf}

\begin{verbatim}
## Error in nlme::gls(y ~ 1, data = data, correlation = nlme::corAR1(form = ~x),  : 
##   singular convergence (7)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# what I need is to extract the output of geom_gls that is NULL (no significant trend)}

\CommentTok{# this may work eventually but blows up R right now, fix later}
\CommentTok{# # get results from ecotrend package}
\CommentTok{# stabletest <- longatBtxttidy %>%}
\CommentTok{#   filter(Time %in% seq(startlast*365, floor(longrunpar$nyears)*365, by=365)) %>%}
\CommentTok{#   group_by(species) %>%}
\CommentTok{#   dplyr::do(ecotrend::glsMs(data = ., formula = yr ~ biomass))}
\CommentTok{# }
\CommentTok{# #ecotrend::glsMs(data = ., formula = yr ~ biomass)}
\CommentTok{# }
\CommentTok{# #ecotrend::glsMs(yr ~ biomass, stabletest)}

\CommentTok{#test this run for persistence too}

\NormalTok{longcrash <-}\StringTok{ }\NormalTok{longatBtxt }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(Time}\OperatorTok{:}\NormalTok{DIN) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{rename_}\NormalTok{(}\DataTypeTok{.dots=}\KeywordTok{with}\NormalTok{(groupslookup, }\KeywordTok{setNames}\NormalTok{(}\KeywordTok{as.list}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(Code)), Name))) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{gather}\NormalTok{(species, biomass, }\OperatorTok{-}\NormalTok{Time) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{yr =} \KeywordTok{ceiling}\NormalTok{(Time}\OperatorTok{/}\DecValTok{365}\NormalTok{))  }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(species, yr) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{meanB =} \KeywordTok{mean}\NormalTok{(biomass)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(meanB }\OperatorTok{<}\StringTok{ }\FloatTok{1e-4}\NormalTok{)}

\CommentTok{# flag any groups with any mean annual biomass below a threshold}

\KeywordTok{unique}\NormalTok{(longcrash}\OperatorTok{$}\NormalTok{species)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Carrion" "MicroPB"
\end{verbatim}

\hypertarget{establish-hindcast-period}{%
\subsubsection{Establish hindcast
period}\label{establish-hindcast-period}}

See discussion
\href{https://github.com/NOAA-EDAB/atneus_RM/issues/7}{here} and
\href{https://github.com/NOAA-EDAB/atneus_RM/wiki/Meeting-minutes\#20191002}{here}.

The period is defined as 1980-2010 for trend comparison. Change it here
to see different results:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hindcast <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1980}\OperatorTok{:}\DecValTok{2010}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Data sources include ecodata and stock assessment outputs for major
species.

\hypertarget{interim-step-which-species-to-include-and-what-data-are-in-the-reference-set-for-comparison}{%
\subsubsection{Interim step: which species to include and what data are
in the reference set for
comparison}\label{interim-step-which-species-to-include-and-what-data-are-in-the-reference-set-for-comparison}}

Not all species need to match, we will first determine the most
important subset(s). Based on discussion, we want to track the species
the comprise 80\% of biomass (and 80\% of catch and 80\% of revenue).

Code to evaluate which species are most important based on biomass,
catch, and revenue, union and intersection.

Species comprising 80\% of survey kg per tow averaged over 1980 to 2010:

Species comprising 80\% of commercial landings averaged over the same
period:

Species comprising 80\% of commercial value averaged over the same
period:

A list with all of these species:

Code to develop the hindcast comparison (call it ``reference'') dataset:

\hypertarget{species-qualitatively-match-trends}{%
\subsubsection{Species qualitatively match
trends}\label{species-qualitatively-match-trends}}

Key species to match and their most representative trend datasets are
determined in analyses above, and the code that looks for the match
between this reference set and Atlantis output is developed here. By
match we mean significance and direction only.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# assumes biom.txt output already read in}
\end{Highlighting}
\end{Shaded}

\hypertarget{references}{%
\subsection*{References}\label{references}}
\addcontentsline{toc}{subsection}{References}

\hypertarget{refs}{}
\leavevmode\hypertarget{ref-kaplan_guinea_2016}{}%
1. Kaplan IC, Marshall KN. A guinea pig's tale: Learning to review
end-to-end marine ecosystem models for management applications. ICES
Journal of Marine Science. 2016;73: 1715--1724.
doi:\href{https://doi.org/10.1093/icesjms/fsw047}{10.1093/icesjms/fsw047}

\leavevmode\hypertarget{ref-pethybridge_calibrating_2019}{}%
2. Pethybridge HR, Weijerman M, Perrymann H, Audzijonyte A, Porobic J,
McGregor V, et al. Calibrating process-based marine ecosystem models: An
example case using Atlantis. Ecological Modelling. 2019;412: 108822.
doi:\href{https://doi.org/10.1016/j.ecolmodel.2019.108822}{10.1016/j.ecolmodel.2019.108822}

\end{document}
